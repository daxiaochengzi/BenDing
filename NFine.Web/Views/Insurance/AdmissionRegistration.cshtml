@{
    ViewBag.Title = "医保入院登记";
    Layout = "~/Views/Shared/_Base.cshtml";
}
<link href="~/Content/js/layui/css/modules/layuiAutocomplete.css" rel="stylesheet" />

<style>
    .layui-card-header.layuibd-card-header-auto {
        padding-top: 15px;
        padding-bottom: 15px;
        height: auto;
    }

    .layuibd-card-header-auto i.layuibd-button-btn {
        position: relative;
        right: 0;
        top: 0;
        vertical-align: middle
    }
</style>
<div class="layui-fluid">
    <div class="layui-card">
        <form class="layui-form layui-form-pane" id="LAY-form" lay-filter="LAY-form-render">
            <input type="hidden" id="bid" value="@ViewBag.bid" placeholder="业务ID" />
            <input type="hidden" id="empid" value="@ViewBag.empid" placeholder="用户ID" />

            <div class="layui-card-header layuibd-card-header-auto">
                <!--搜索部分-->
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">身份标识</label>
                        <div class="layui-input-inline">
                            <select id="IdentityMark" lay-verify="required">
                                <option value="">请选择条件</option>
                                <option value="1" selected>身份证号</option>
                                <option value="2">个人编号</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">身份证号</label>
                        <div class="layui-input-inline">
                            <input type="text" id="IdCardNo" placeholder="请输入身份标识" value="511521201704210171" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">入院日期</label>
                        <div class="layui-input-inline">
                            <input type="text" id="AdmissionDate1" value="" placeholder="请选择入院日期" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn" lay-submit="" lay-filter="LAY-form-search">
                            <i class="layui-icon layui-icon-search layuibd-button-btn"></i>
                        </button>
                    </div>
                </div>

                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>病人信息</legend>
                </fieldset>
                <!--主体部分-->
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">住院编号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="HospitalizationNo" autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">个人编号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PersonalCoding" @*lay-verify="required|number"*@ autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">身份证号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="IdCardNo" @*lay-verify="required|number"*@ autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">患者姓名</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientName" autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">性别</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientSex" autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">主诊医生</label>
                        <div class="layui-input-inline">
                            <input type="text" name="AdmissionDiagnosticDoctor" autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">入院日期</label>
                        <div class="layui-input-inline">
                            <input type="text" name="AdmissionDate" id="AdmissionDate" @*lay-verify="date"*@ placeholder="yyyy-MM-dd" disabled autocomplete="off" class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">住院科室</label>
                        <div class="layui-input-inline">
                            <input type="text" name="InDepartmentName" autocomplete="off" disabled class="layui-input layui-disabled">
                            <input type="hidden" name="InDepartmentId" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">床位号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="AdmissionBed" autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">险种类型</label>
                        <div class="layui-input-inline">
                            <select name="InsuranceType" @*lay-verify="required"*@ disabled>
                                <option value="">请选择险种类型</option>
                                <option value="310">城镇职工</option>
                                <option value="342">城乡居民</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">户口性质</label>
                        <div class="layui-input-inline">
                            <select name="InsuranceType" @*lay-verify="required"*@ disabled>
                                <option value="">请选择户口性质</option>
                                <option value="10">城镇户口</option>
                                <option value="20">农业户口</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">医疗类别</label>
                        <div class="layui-input-inline">
                            <select id="MedicalCategory" name="MedicalCategory" lay-filter="MedicalCategoryType" @*lay-verify="required"*@ disabled>
                                <option value="">请选择医疗类别</option>
                                <option value="11">11-普通入院</option>
                                <option value="14">14-大病门诊</option>
                                <option value="15">15-大病住院</option>
                                <option value="22">22-急诊入院</option>
                                <option value="23">23-市内转院住院</option>
                                <!--Layui下拉菜单的监听事件,实现元素的隐藏和显示-->
                                <option value="41">41-病理剖宫产</option>
                                <option value="71">71-顺产</option>
                                <option value="72">72-剖宫产</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline" id="FetusNumberId" style="display: none;">
                        <label class="layui-form-label">胎儿数</label>
                        <div class="layui-input-inline">
                            <input type="text" name="FetusNumber" autocomplete="off" disabled class="layui-input layui-disabled">
                        </div>
                    </div>


                </div>
            </div>

            <div class="layui-card-body" lay-size="sm">
                <!--诊断部分-->
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>诊断列表</legend>
                </fieldset>
                <!--搜索部分-->
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">录入诊断</label>
                        <div class="layui-input-inline" style="width:280px;">
                            <input type="text" id="DiagnosisSearch" placeholder="请输入诊断名称/编码/助记码" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn" lay-submit lay-filter="LAY-diagnosis-search">
                            <i class="layui-icon layui-icon-search"></i>
                        </button>
                    </div>
                </div>
                <!--诊断列表-->
                <table class="layui-table" lay-size="sm" lay-filter="EditListTable">
                    <thead>
                        <tr>
                            <th lay-data="{type:'numbers',align:'center', width:60}">序号</th>
                            <th lay-data="{field:'DiagnosisName',align:'center', edit: 'text', width:280}">诊断名称</th>
                            <th lay-data="{field:'DiagnosisCode',align:'center', edit: 'text', width:280}">诊断代码</th>
                            <!--<th lay-data="{align:'center', width:120,templet:'#diagnosticResult' }">诊断结果</th>-->
                            <th lay-data="{field:'IsMainDiagnosis',align:'center', width:160 ,templet: '#switchMain'}">主诊</th>
                            <th lay-data="{align:'center', toolbar: '#handleBtn', fixed: 'right'}">操作</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="layui-form-item" style="text-align: center;margin-top: 20px;">
                <button type="submit" class="layui-btn layui-btn-radius" lay-submit lay-filter="reg">登记</button>
            </div>
        </form>
    </div>
</div>
<script>
    (function () {

        layui.config({
            base: '/Content/js/layui/plugin/' //假设这是test.js所在的目录
        }).extend({ //设定模块别名
            autocomplete: 'layAutoComplete'
        });

        layui.use(['form', 'laypage', 'layer', 'table', 'element', 'laydate', 'autocomplete'], function () {
            var $ = layui.$
                //Tab的切换功能，切换事件监听等，需要依赖element模块
                , element = layui.element
                , form = layui.form
                , layer = layui.layer
                , table = layui.table
                , laydate = layui.laydate;
            /**
            form.render(); //更新全部
            form.render('select'); //刷新select选择框渲染,checkbox,radio
            form.render('select', 'test2'); //更新 lay-filter="test2" 所在容器内的全部 select 状态
            */
            form.render(null, 'LAY-form-render'); //更新 lay-filter="LAY-form-render" 所在容器内的全部表单状态
            //执行一个laydate实例
            laydate.render({ elem: '#AdmissionDate1' });
            //指定入院日期
            laydate.render({ elem: '#AdmissionDate' });
            /**根据当前住院病人的业务ID查询,返回数据回显到下面表单里面*/
            form.on('submit(LAY-form-search)', function (data) {
                var params = {
                    "IdCardNo":  $("#IdCardNo").val() /*身份证号*/
                    ,"StartTime":  $("#AdmissionDate1").val() /*查询开始日期，必传*/
                    ,"IdentityMark":  $("#IdentityMark").val() /*身份标志，1:身份证,2:医保个人编码*/
                    ,"BusinessId":  $("#bid").val() /*当前住院记录的业务ID*/
                    ,"UserId": $("#empid").val() /*授权操作人的ID*/
                }
                $.ajax({
                    type: 'POST',
                    url: '/BenDing/GetInpatientInfo',
                    data: params,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        if (data.Success === false) {
                            var errData = data.Message;
                            //样式类名:墨绿深蓝风
                            layer.alert(errData, { skin: 'layui-layer-molv', icon: 3, title: '提示' });
                        } else {
                            var resData = data.Data;
                            //查询之前，主体部分所有输入或选择框是禁用的，现在要去掉
                            $(".layui-input-inline").each(function (i, e) {
                                var itemInput = $(this).find("input");
                                var itemSelect = $(this).find("select");
                                if (itemInput.attr("disabled")) {
                                    itemInput.removeAttr("disabled").removeClass("layui-disabled");
                                }
                                if (itemSelect.attr("disabled")) {
                                    itemSelect.removeAttr("disabled");
                                }
                            });
                            //查询返回的数据回显到主体部分
                            jsonToForm(resData, "LAY-form");
                            //诊断表初始化
                            createTable(params);
                        }
                    },
                    complete: function () {
                        //layer.close(this.layerIndex);
                        //刷新
                        form.render();
                    },
                });
                return false;//阻止表单跳转
            });
           

            //form数据回显:数据回显到Form表单主体部分
            var jsonToForm = function (jsonData, formId) {
                var serializeArray = $("#" + formId).serializeArray();
                for (var i = 0; i < serializeArray.length; i++) {
                    var name = serializeArray[i].name;
                    if (jsonData[name]) {
                        var value = jsonData[name];
                        $("[name='" + name + "']").val(value);
                    }
                    if (jsonData.MedicalInsuranceResidentInfo[name]) {
                        var value = jsonData.MedicalInsuranceResidentInfo[name];
                        $("[name='" + name + "']").val(value);
                    }
                }
            };

            //MedicalCategoryType医疗类别 隐藏显示胎儿数输入框
            form.on('select(MedicalCategoryType)', function (data) {
                var val = data.value;
                //layer.alert(val, { icon: 1 });
                if (val == 41 || val == 71 || val == 72) {
                    $("#FetusNumberId").show(); //胎儿数输入框
                } else {
                    $("#FetusNumberId").hide();
                }
            });

            //主诊切换
            form.on('switch(diagnosticMain)', function (obj) {
                layer.tips(this.value + ' ' + this.name + '：' + obj.elem.checked, obj.othis);
            });

            //表初始化
            var createTable = function (params) {
                //table.init('EditListTable', tableOptions); // table lay-filter
                table.init('EditListTable', {
                    url: '/BenDing/GetInpatientDiagnosis', //请求地址
                    method: 'POST', //方式
                    id: 'listReload', //生成 Layui table 的标识 id，必须提供，用于后文刷新操作，笔者该处出过问题
                    page: false, //是否分页
                    where: params,
                    parseData: function (result) { //result 即为原始返回的数据
                        return {
                            "code": result.Code, //解析接口状态
                            "msg": result.Message, //解析提示文本
                            //"count": result.Data.count, //解析数据长度
                            "data": result.Data //解析数据列表
                        };
                    }
                }); // table lay-filter
            };
            //表刷新方法
            var reloadTable = function (item) {
                table.reload("listReload", { //此处是上文提到的 初始化标识id
                    where: {
                        //key: { //该写法上文已经提到
                        type: item.type,
                        id: item.id
                        //}
                    }
                });
            };
            //录入诊断
            layui.autocomplete({
                element: '#DiagnosisSearch',
                num: 2,
                display: 'DiseaseName',
                shortcut: 'MnemonicCode',
                url: '/BenDing/QueryICD10',
                query: {},
                resArray: 'Data',
                count: 10,
                done: function (item) {
                    //alert(JSON.stringify(item))
                    //追加到listReload上
                    var tr = " <tr>" +
                        "  <td>" + item.DiseaseName + "</td>" +
                        "  <td>" + item.DiseaseCoding + "</td>" +
                        "  </tr>";
                    $(".layui-table-body .layui-table").append(tr);
                }
            })

            //监听工具条
            table.on('tool(EditListTable)', function (obj) {
                var data = obj.data;
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    });
                }
            });
        })
    })();

</script>
<script type="text/html" id="handleBtn">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script type="text/html" id="diagnosticResult">
    <select name='DiagnosticResult' lay-verify='' lay-search=''>
        <option value="治愈">治愈</option>
        <option value="好转">好转</option>
        <option value="未愈">未愈</option>
        <option value="死亡">死亡</option>
        <option value="转院">转院</option>
        <option value="其他">其他</option>
    </select>
</script>
<script type="text/html" id="switchMain">
    <!-- 主诊 -->
    <input type="checkbox" name="MainDiagnosis" class="layui-btn-xs" value="{{d.IsMainDiagnosis}}" lay-skin="switch" lay-text="是|否" lay-filter="diagnosticMain" {{ d.IsMainDiagnosis == true ? 'checked' : '' }}>
</script>